<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Brocki Buchsuche</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: 30px auto;
  padding: 10px;
}
input, button, select {
  font-size: 1em;
  padding: 8px;
  margin: 4px 0;
  width: 100%;
}
.book {
  display: flex;
  border-bottom: 1px solid #ccc;
  padding: 15px 0;
}
.cover img {
  width: 120px;
}
.info {
  margin-left: 15px;
  flex: 1;
}
.price {
  font-size: 1.3em;
  font-weight: bold;
}
.links a {
  margin-right: 8px;
  font-size: 0.9em;
}
.eurobuch {
  background: #f0f0f0;
  padding: 10px;
  margin-top: 10px;
  border: 1px solid #aaa;
}
#version {
  margin-top: 30px;
  font-size: 0.9em;
  color: #666;
}
</style>
</head>

<body>

<h1>ðŸ“š Brocki Buchsuche</h1>

<input id="searchInput" placeholder="ISBN, Titel oder Autor">
<button onclick="search()">Suchen</button>

<div id="results"></div>

<div id="version">Version 1.4 â€“ lernende Preisempfehlung</div>

<script>
// ------------------ GRUNDLAGEN ------------------
const BASE_PRICE = 25;
const conditionFactor = {
  "wie neu": 1.2,
  "sehr gut": 1.0,
  "gut": 0.8,
  "akzeptabel": 0.6,
  "beschÃ¤digt": 0.4
};
const demandFactor = {
  "Bestseller": 1.3,
  "Standard": 1.0,
  "Nische": 0.8
};

// ------------------ SALES STORAGE ------------------
function getSales() {
  return JSON.parse(localStorage.getItem("sales") || "{}");
}
function saveSale(isbn, price) {
  if (!isbn || !price) return alert("Preis oder ISBN fehlt");
  let sales = getSales();
  if (!sales[isbn]) sales[isbn] = [];
  sales[isbn].push({ price: parseFloat(price), date: new Date().toISOString() });
  localStorage.setItem("sales", JSON.stringify(sales));
  alert("âœ… Verkauf gespeichert");
}
function averageSale(isbn) {
  let sales = getSales()[isbn];
  if (!sales || sales.length === 0) return null;
  return sales.reduce((a,b)=>a+b.price,0) / sales.length;
}

// ------------------ PREISLOGIK ------------------
function smartPrice(base, condition, demand, year, isbn) {
  let ageFactor = 1 - ((new Date().getFullYear() - year) * 0.02);
  ageFactor = Math.max(0.6, ageFactor);
  let heuristic = base * conditionFactor[condition] * demandFactor[demand] * ageFactor;
  let avg = averageSale(isbn);
  if (!avg) return heuristic.toFixed(2);
  return (heuristic * 0.6 + avg * 0.4).toFixed(2);
}

// ------------------ SUCHE ------------------
async function search() {
  const q = searchInput.value.trim();
  if (!q) return;
  results.innerHTML = "ðŸ” Suche lÃ¤uftâ€¦";

  const res = await fetch("https://openlibrary.org/search.json?q=" + encodeURIComponent(q));
  const data = await res.json();
  if (!data.docs.length) return results.innerHTML = "âŒ Keine Treffer";

  results.innerHTML = "";
  data.docs.slice(0,5).forEach(b => renderBook(b, q));
}

// ------------------ RENDER ------------------
function renderBook(b, q) {
  const isbn = b.isbn ? b.isbn[0] : "";
  const year = b.first_publish_year || new Date().getFullYear();
  const title = b.title || "";
  const author = b.author_name ? b.author_name.join(", ") : "";
  const cover = isbn ? `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg` : "";

  const div = document.createElement("div");
  div.className = "book";
  div.innerHTML = `
    <div class="cover">${cover ? `<img src="${cover}">` : ""}</div>
    <div class="info">
      <h2>${title}</h2>
      <p>${author}</p>
      <p>ISBN: ${isbn || "â€“"} | Jahr: ${year}</p>

      <label>Zustand</label>
      <select class="condition">
        <option>wie neu</option><option>sehr gut</option><option>gut</option>
        <option>akzeptabel</option><option>beschÃ¤digt</option>
      </select>

      <label>Nachfrage</label>
      <select class="demand">
        <option>Bestseller</option><option>Standard</option><option>Nische</option>
      </select>

      <p class="price">Empfohlener Preis: <span>â€“</span> CHF</p>

      <input type="number" placeholder="Verkaufspreis CHF" class="sale">
      <button>Verkauf speichern</button>

      <div class="links">
        <a href="https://www.orellfuessli.ch/shop/home/search?q=${encodeURIComponent(q)}" target="_blank">Orell FÃ¼ssli</a>
        <a href="https://www.exlibris.ch/de/suche?searchTerm=${encodeURIComponent(q)}" target="_blank">Ex Libris</a>
        <a href="https://www.eurobuch.ch/search_results.php?search=${encodeURIComponent(q)}" target="_blank">Eurobuch</a>
      </div>
    </div>
  `;
  results.appendChild(div);

  const priceSpan = div.querySelector(".price span");
  const update = () => priceSpan.textContent =
    smartPrice(BASE_PRICE, div.querySelector(".condition").value,
      div.querySelector(".demand").value, year, isbn);

  div.querySelector(".condition").onchange = update;
  div.querySelector(".demand").onchange = update;
  div.querySelector("button").onclick = () =>
    saveSale(isbn, div.querySelector(".sale").value);

  update();
}

// ENTER-TASTE
searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") search();
});
</script>

</body>
</html>
