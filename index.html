<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Brocki Buchsuche v1.3</title>
<style>
body { font-family: Arial, sans-serif; max-width: 750px; margin: 40px auto; padding: 10px; }
input, button, select { font-size: 1.1em; padding: 8px; margin-bottom: 10px; width: 100%; }
#result { margin-top: 20px; border-top:1px solid #ccc; padding-top:15px; }
.book { margin-bottom: 20px; padding-bottom: 10px; border-bottom:1px solid #ddd; display:flex; }
.cover { margin-right: 15px; }
.cover img { width: 120px; }
.info { flex: 1; }
a { display: inline-block; margin: 2px 5px 2px 0; color: #0066cc; text-decoration: none; }
a:hover { text-decoration: underline; }
#version { margin-top: 30px; font-size: 0.9em; color: #666; }
.eurobuch-form { margin-top: 10px; padding: 10px; border: 1px solid #aaa; background-color: #f0f0f0; width: fit-content; }
</style>
</head>
<body>

<h1>üìö Brocki Buchsuche</h1>

<input id="searchText" placeholder="ISBN, Titel oder Autor">
<button onclick="searchBook()">Suchen</button>

<div id="result"></div>

<div id="version">Version 1.3</div>

<script>
// Beispielhafte Preisliste (Neupreis in CHF)
const priceList = {
  "9780140449136": 35,
  "9783453172793": 28,
  "9783832180577": 22
};

// Faktor-Definitionen
const zustandFactor = {
  "wie neu": 1.2,
  "sehr gut": 1.0,
  "gut": 0.8,
  "akzeptabel": 0.6,
  "besch√§digt": 0.4
};
const nachfrageFactor = {
  "Bestseller": 1.3,
  "Standard": 1.0,
  "Nische": 0.8
};

async function searchBook() {
  const query = document.getElementById("searchText").value.trim();
  const resDiv = document.getElementById("result");

  if (!query) {
    resDiv.innerHTML = "<p>Bitte zuerst etwas eingeben.</p>";
    return;
  }

  resDiv.innerHTML = "<p>üîç Suche l√§uft‚Ä¶</p>";

  try {
    const resp = await fetch("https://openlibrary.org/search.json?q=" + encodeURIComponent(query));
    const data = await resp.json();

    if (!data.docs || data.docs.length === 0) {
      resDiv.innerHTML = "<p>‚ùå Keine B√ºcher gefunden.</p>";
      return;
    }

    const books = data.docs.slice(0,5);
    let html = "";

    books.forEach(book => {
      const title = book.title || "‚Äì";
      const author = book.author_name ? book.author_name.join(", ") : "‚Äì";
      const isbn = book.isbn ? book.isbn[0] : "";
      const pubYear = book.first_publish_year || new Date().getFullYear();

      const coverUrl = isbn ? `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg` : "";

      let neupreis = 25;
      if(isbn && priceList[isbn]) neupreis = priceList[isbn];

      // Dropdowns f√ºr Zustand & Nachfrage
      let zustandSelect = `<select class="zustand"><option value="wie neu">wie neu</option>
<option value="sehr gut">sehr gut</option><option value="gut">gut</option>
<option value="akzeptabel">akzeptabel</option><option value="besch√§digt">besch√§digt</option></select>`;

      let nachfrageSelect = `<select class="nachfrage"><option value="Bestseller">Bestseller</option>
<option value="Standard">Standard</option><option value="Nische">Nische</option></select>`;

      html += `<div class="book" data-isbn="${isbn}" data-neupreis="${neupreis}" data-pubyear="${pubYear}">
        <div class="cover">${coverUrl ? `<img src="${coverUrl}" alt="Cover">` : "Kein Cover verf√ºgbar"}</div>
        <div class="info">
          <h2>${title}</h2>
          <p><b>Autor:</b> ${author}</p>
          ${isbn ? `<p><b>ISBN:</b> ${isbn}</p>` : "<p>‚ö†Ô∏è Keine ISBN gefunden.</p>"}
          <p>üí∞ Preisvorschlag: <span class="preisVorschlag">${(neupreis/5).toFixed(2)}</span> CHF</p>
          <p>Zustand: ${zustandSelect}</p>
          <p>Nachfrage: ${nachfrageSelect}</p>
          <p>
            <a href="https://www.melando.ch/de/books?search=${encodeURIComponent(query)}" target="_blank">Melando</a>
            <a href="https://www.medimops.de/search?query=${encodeURIComponent(query)}" target="_blank">Medimops</a>
            <a href="https://www.zvab.com/search?q=${encodeURIComponent(query)}" target="_blank">ZVAB</a>
            <a href="https://www.buchplanet.ch/?s=${encodeURIComponent(query)}" target="_blank">Buchplanet</a>
          </p>
          <p>
            <a href="https://www.orellfuessli.ch/shop/home/search?q=${encodeURIComponent(query)}" target="_blank">Orell F√ºssli</a>
            <a href="https://www.exlibris.ch/de/suche?searchTerm=${encodeURIComponent(query)}" target="_blank">Ex Libris</a>
          </p>
        </div>
      </div>`;

    });

    resDiv.innerHTML = html;

    // Preisberechnung bei √Ñnderung
    document.querySelectorAll('.book').forEach(bookDiv=>{
      const preisSpan = bookDiv.querySelector('.preisVorschlag');
      const zustandSel = bookDiv.querySelector('.zustand');
      const nachfrageSel = bookDiv.querySelector('.nachfrage');
      const neupreis = parseFloat(bookDiv.dataset.neupreis);
      const pubYear = parseInt(bookDiv.dataset.pubyear);
      const currentYear = new Date().getFullYear();

      function updatePreis() {
        let zust = zustandFactor[zustandSel.value] || 1.0;
        let nachfrage = nachfrageFactor[nachfrageSel.value] || 1.0;
        let alterF = 1 - ((currentYear - pubYear)*0.02);
        alterF = Math.max(0.6, Math.min(alterF, 1.0));
        const preis = (neupreis * zust * nachfrage * alterF).toFixed(2);
        preisSpan.textContent = preis;
      }

      zustandSel.addEventListener('change', updatePreis);
      nachfrageSel.addEventListener('change', updatePreis);
      updatePreis();
    });

  } catch(err){
    console.error(err);
    resDiv.innerHTML="<p>‚ö†Ô∏è Fehler bei der Suche.</p>";
  }
}

// Enter-Taste aktivieren
document.getElementById("searchText").addEventListener("keydown", function(e){
  if(e.key === "Enter") searchBook();
});
</script>

</body>
</html>
