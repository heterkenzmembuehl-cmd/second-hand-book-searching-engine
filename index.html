<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Brocki Buchsuche</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 1000px;
  margin: 30px auto;
  padding: 10px;
}
input, button {
  padding: 8px;
  margin: 4px 0;
  width: 100%;
}
.book {
  border-bottom: 1px solid #ccc;
  padding: 15px 0;
}
.cover img {
  width: 140px;
}
.row {
  display: flex;
}
.info {
  margin-left: 15px;
}
.newprice {
  font-size: 1.6em;
  color: #0a7;
  font-weight: bold;
}
.detail {
  display: none;
  background: #f7f7f7;
  padding: 15px;
  margin-top: 10px;
}
.meant {
  color: #d67c00;
  font-style: italic;
  margin-bottom: 10px;
}
#version {
  margin-top: 30px;
  color: #666;
}
a.publisher {
  color: #0066cc;
}
</style>
</head>

<body>

<h1>ðŸ“š Brocki Buchsuche</h1>

<input id="searchInput" placeholder="ISBN, Titel oder Autor">
<button onclick="search()">Suchen</button>

<div id="results"></div>

<div id="version">Version 1.7 â€“ Meintest du & Verlag-Link</div>

<script>
// ----------------- HILFSFUNKTIONEN -----------------

function levenshtein(a, b) {
  const m = [];
  for (let i = 0; i <= b.length; i++) m[i] = [i];
  for (let j = 0; j <= a.length; j++) m[0][j] = j;
  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      m[i][j] = b.charAt(i-1) === a.charAt(j-1)
        ? m[i-1][j-1]
        : Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
    }
  }
  return m[b.length][a.length];
}

function similarity(a, b) {
  const dist = levenshtein(a.toLowerCase(), b.toLowerCase());
  return 1 - dist / Math.max(a.length, b.length);
}

function publisherLink(name) {
  if (!name) return null;
  const domain = name.toLowerCase().replace(/[^a-z]/g,"");
  return `https://www.${domain}.de`;
}

// ----------------- GOOGLE BOOKS -----------------
async function googleBooks(isbn) {
  if (!isbn) return null;
  const r = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
  const j = await r.json();
  if (!j.items) return null;
  const v = j.items[0];
  return {
    title: v.volumeInfo.title,
    authors: v.volumeInfo.authors?.join(", "),
    publisher: v.volumeInfo.publisher || null,
    year: v.volumeInfo.publishedDate?.substring(0,4) || null,
    pages: v.volumeInfo.pageCount || null,
    cover: v.volumeInfo.imageLinks?.thumbnail || "",
    price: v.saleInfo?.listPrice?.amount || null
  };
}

// ----------------- SUCHE -----------------
async function search() {
  const q = searchInput.value.trim();
  if (!q) return;
  results.innerHTML = "ðŸ” Suche lÃ¤uftâ€¦";

  const r = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(q)}`);
  const j = await r.json();
  results.innerHTML = "";

  let bestMatch = null;
  let bestScore = 0;

  j.docs.forEach(d => {
    const title = d.title || "";
    const s = similarity(q, title);
    if (s > bestScore) {
      bestScore = s;
      bestMatch = title;
    }
  });

  if (bestScore > 0.6 && bestScore < 0.9) {
    results.innerHTML += `<div class="meant">Meintest du: <b>${bestMatch}</b>?</div>`;
  }

  j.docs.slice(0,5).forEach(b => renderBook(b));
}

// ----------------- RENDER -----------------
async function renderBook(b) {
  const isbn = b.isbn ? b.isbn[0] : "";
  const g = await googleBooks(isbn);

  const pubLink = g?.publisher ? publisherLink(g.publisher) : null;

  const div = document.createElement("div");
  div.className = "book";

  div.innerHTML = `
    <div class="row">
      <div class="cover">${g?.cover ? `<img src="${g.cover}">` : ""}</div>
      <div class="info">
        <h2>${g?.title || b.title}</h2>
        <p><b>Autor:</b> ${g?.authors || "â€“"}</p>
        <p><b>ISBN:</b> ${isbn}</p>
        <p><b>Seiten:</b> ${g?.pages || "â€“"}</p>
        <p><b>Jahr:</b> ${g?.year || "â€“"}</p>
        <p><b>Verlag:</b>
          ${g?.publisher
            ? `<a class="publisher" target="_blank" href="${pubLink}">${g.publisher}</a>`
            : "â€“"}
        </p>
        ${g?.price ? `<div class="newprice">Neupreis: ${g.price} CHF</div>` : ""}
      </div>
    </div>

    <div class="detail">
      <p>Weitere Auswertungen folgenâ€¦</p>
    </div>
  `;

  div.onclick = () => {
    const d = div.querySelector(".detail");
    d.style.display = d.style.display === "block" ? "none" : "block";
  };

  results.appendChild(div);
}

// ENTER
searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") search();
});
</script>

</body>
</html>
