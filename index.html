<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Brocki Buchsuche</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 1000px;
  margin: 30px auto;
  padding: 10px;
}
input, button, select {
  padding: 8px;
  margin: 4px 0;
  width: 100%;
}
.book {
  border-bottom: 1px solid #ccc;
  padding: 15px 0;
  cursor: pointer;
}
.row {
  display: flex;
}
.cover img {
  width: 140px;
}
.info {
  margin-left: 15px;
  flex: 1;
}
.newprice {
  font-size: 1.6em;
  color: #0a7;
  font-weight: bold;
}
.detail {
  display: none;
  margin-top: 15px;
  background: #f7f7f7;
  padding: 15px;
}
canvas {
  background: #fff;
  border: 1px solid #ccc;
  margin-top: 10px;
}
#version {
  margin-top: 30px;
  color: #666;
}
</style>
</head>

<body>

<h1>ðŸ“š Brocki Buchsuche</h1>

<input id="searchInput" placeholder="ISBN, Titel oder Autor">
<button onclick="search()">Suchen</button>

<div id="results"></div>

<div id="version">Version 1.6 â€“ Metadaten & Nachfragegrafiken</div>

<script>
const DEFAULT_BASE_PRICE = 25;

// ---------- STORAGE ----------
function getData(key) {
  return JSON.parse(localStorage.getItem(key) || "{}");
}
function saveData(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

// ---------- GOOGLE BOOKS ----------
async function googleBooks(isbn) {
  if (!isbn) return null;
  const r = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
  const j = await r.json();
  if (!j.items) return null;
  const v = j.items[0];
  return {
    title: v.volumeInfo.title,
    authors: v.volumeInfo.authors?.join(", "),
    publisher: v.volumeInfo.publisher || "â€“",
    pages: v.volumeInfo.pageCount || "â€“",
    year: v.volumeInfo.publishedDate?.substring(0,4) || "â€“",
    cover: v.volumeInfo.imageLinks?.thumbnail || "",
    price: v.saleInfo?.listPrice?.amount || null
  };
}

// ---------- DEMAND ----------
function logDemand(isbn) {
  let d = getData("demand");
  d[isbn] = d[isbn] || [];
  d[isbn].push({ date: Date.now(), value: 1 });
  saveData("demand", d);
}

// ---------- SALES ----------
function saveSale(isbn, price) {
  let s = getData("sales");
  s[isbn] = s[isbn] || [];
  s[isbn].push({ date: Date.now(), price: parseFloat(price) });
  saveData("sales", s);
  alert("Verkauf gespeichert");
}

// ---------- CHART ----------
function drawChart(canvas, data, key) {
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (data.length < 2) return;

  const max = Math.max(...data.map(d=>d[key]));
  ctx.beginPath();
  data.forEach((d,i)=>{
    const x = (i/(data.length-1))*canvas.width;
    const y = canvas.height - (d[key]/max)*canvas.height;
    ctx.lineTo(x,y);
  });
  ctx.strokeStyle = "#0077cc";
  ctx.stroke();
}

// ---------- SEARCH ----------
async function search() {
  const q = searchInput.value.trim();
  if (!q) return;
  results.innerHTML = "Suche lÃ¤uftâ€¦";

  const r = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(q)}`);
  const j = await r.json();
  results.innerHTML = "";

  j.docs.slice(0,5).forEach(b=>renderBook(b));
}

// ---------- RENDER ----------
async function renderBook(b) {
  const isbn = b.isbn ? b.isbn[0] : "";
  logDemand(isbn);

  const g = await googleBooks(isbn);

  const div = document.createElement("div");
  div.className = "book";

  div.innerHTML = `
    <div class="row">
      <div class="cover">${g?.cover ? `<img src="${g.cover}">` : ""}</div>
      <div class="info">
        <h2>${g?.title || b.title}</h2>
        <p><b>Autor:</b> ${g?.authors || "â€“"}</p>
        <p><b>Verlag:</b> ${g?.publisher}</p>
        <p><b>Seiten:</b> ${g?.pages}</p>
        <p><b>Erscheinungsjahr:</b> ${g?.year}</p>
        <p><b>ISBN:</b> ${isbn}</p>
        ${g?.price ? `<div class="newprice">Neupreis: ${g.price} CHF</div>` : ""}
      </div>
    </div>

    <div class="detail">
      <h3>ðŸ“ˆ Nachfrage</h3>
      <canvas width="400" height="150"></canvas>

      <h3>ðŸ’° Preisentwicklung</h3>
      <canvas width="400" height="150"></canvas>

      <input type="number" placeholder="Verkaufspreis CHF">
      <button>Verkauf speichern</button>
    </div>
  `;

  div.onclick = () => {
    const d = div.querySelector(".detail");
    d.style.display = d.style.display === "block" ? "none" : "block";

    const demand = getData("demand")[isbn] || [];
    const sales = getData("sales")[isbn] || [];

    drawChart(d.querySelectorAll("canvas")[0], demand.map((v,i)=>({v:i+1})), "v");
    drawChart(d.querySelectorAll("canvas")[1], sales, "price");
  };

  div.querySelector("button").onclick = e => {
    e.stopPropagation();
    saveSale(isbn, div.querySelector("input").value);
  };

  results.appendChild(div);
}

// ENTER
searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") search();
});
</script>

</body>
</html>
